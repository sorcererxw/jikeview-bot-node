version: 2
jobs:
  build:
    branches:
      only:
        - master
        - ci
    docker:
      - image: circleci/openjdk:8-jdk-browsers
    steps:
      - checkout # clone repository
      - setup_remote_docker # setup docker env
      - run: chmod +x ./gradlew
      - run: export version=$(./gradlew :app:getVersion -q)
      - run: ./gradlew dockerBuildImage
      - run: docker images
      - run: docker login -u $docker_username -p $docker_password
      - run: docker tag sorcererxw/jikeview-bot:$version sorcererxw/jikeview-bot:latest
      - run: docker push sorcererxw/jikeview-bot:$version
      - run: docker push sorcererxw/jikeview-bot:latest
      - run: ssh -T $server_user@$server_address "bash -s" <./scripts/deploy.sh $bot_name $bot_token